!function(){"use strict";angular.module("kt.pano").controller("ktOverviewCtrl",["$scope","$q","$state","$templateRequest","$window","$stateParams","ktDataHelper","ktAnalyticsService","ktValueFactory","ktEchartTheme1",function(a,b,c,d,e,f,g,h,i,j){a.updateDate="获取中...",a.updateDateTo="获取中...",a.getLife=g.getLife,a.goTo=function(a,b){a.stopPropagation(),window.open(b,"_blank")},a.getRate=function(a,b){return _.isNil(a)&&_.isNil(b)?"-":_.isNil(a)&&!_.isNil(b)?b.toFixed(2)+"%":_.isNil(b)&&!_.isNil(a)?a.toFixed(2)+"%":a===b?a.toFixed(2)+"%":a.toFixed(2)+"%-"+b.toFixed(2)+"%"};var k=j.color,l={text:"努力加载中...",color:"#3d4351",textColor:"#3d4351"},m={yAxis:{axisLine:{show:!1,lineStyle:{width:1,color:"#afb7d0"}},splitLine:{show:!0,lineStyle:{color:["#f3f3f3"],width:1,type:"solid"}},splitArea:{show:!1,areaStyle:{color:["rgba(250,250,250,0.3)","rgba(200,200,200,0.3)"]}}},grid:{right:60},tooltip:{valueType:"rmb"}},n=a.rateAmountChart={chartOptions:{},yAxis:"amount",yAxisFormat:"rmb",xAxis:"rate",xAxisFormat:"percent2",color:["#dd4444"],tab:"last7days",list:[]};n.updateDataView=function(b,d){function e(){var a=f.data,b=_.map(a,function(a){return a[2]}),d=g.chartOptions("#rateAmountChart",b),e=_.map(a,function(a){return a[0]}),h=_.map(a,function(a){return a[1]});f.chartOptions=$.extend(!0,{},m,d,{onclick:function(a){var b=c.href("pano.institutions.detail",{id:a.seriesName});window.open(b,"_blank")},legend:{data:b},tooltip:{axisPointer:{axis:"auto",type:"line"},trigger:"item",triggerOn:"mousemove",formatter:function(a){var b='<div class="f1_2rem chart-tooltip-title" style="border-bottom: 1px solid rgba(255,255,255,.3);padding-bottom: 5px;margin-bottom:5px;">'+a.value[2]+'</div><table class="f1_2rem chart-tooltip-table"><tr><td class="justify">加权收益率：</td><td>'+i(a.value[0],f.xAxisFormat)+'</td></tr><tr><td class="justify">发行量：</td><td>'+i(a.value[1],f.yAxisFormat)+"</td></tr>";return b},xAxisFormat:f.xAxisFormat,yAxisFormat:f.yAxisFormat},visualMap:[{show:!1,dimension:1,min:_.min(h),max:_.max(h),precision:1,inRange:{symbolSize:[10,50]},outOfRange:{symbolSize:[10,50],color:["rgba(0,0,0,.2)"]}}],yAxis:{name:"发行量（万元）",boundaryGap:!0,type:"log"},xAxis:{max:function(){var a=_.max(e),b=_.round(a-(0|a),2);return _.ceil(a)+1*(b>.8)}(),min:function(){var a=_.min(e),b=_.round(a-(0|a),2);return _.floor(a)-1*(.3>b)}(),type:"value",name:"收益率",nameLocation:"end",nameGap:10,boundaryGap:!1},series:_.map(a,function(a){return{name:a[2],showEffectOn:"emphasis",itemStyle:{normal:{opacity:.7}},type:"effectScatter",rippleEffect:{period:8,scale:1.5,brushType:"fill"},data:[a]}})}),j&&j.hideLoading()}var f=this,j=f.echart=echarts.getInstanceByDom($("#rateAmountChart")[0]);d&&j&&(j.hideLoading(),j.showLoading(l)),h.get($.extend({content:"overview",chart:"summary"},b||{}),function(b){f.data=g.sortByChars(b.stat),b.crawled_at&&(a.updateDate=moment(b.crawled_at).subtract(6,"d").format("YYYY-MM-DD")+" ~ "+moment(b.crawled_at).format("YYYY-MM-DD"),a.updateDateTo=moment(b.crawled_at).format("YYYY-MM-DD")),e()})},a.$watch("rateAmountChart.tab",function(a,b){_.isUndefined(a)||a===b||n.updateDataView({chart:"last7days"===a?"summary":"history"},!0)});var o=a.durationAmountChart={chartOptions:{},yAxis:"amount",yAxisFormat:"rmb",yAxisFormat2:"percent2",xAxis:"_id",xAxisFormat:null,list:[]};o.updateDataView=function(){function a(){var a=c.data1,b=c.data2,d=_.concat(_.map(a.data,"name"),_.map(b.data,"name")),e=_.concat(k.slice(0,2),k.slice(0,2)),f=g.chartOptions("#durationAmountChart",d);c.chartOptions=$.extend(!0,{},m,f,{color:e,legend:{data:d},tooltip:{titlePrefix:"产品期限：",xAxisFormat:c.xAxisFormat,yAxisFormat:c.yAxisFormat+"{0,1}|"+c.yAxisFormat2+"{2,3}"},yAxis:[{name:"发行量（万元）",textStyle:{color:"#666b76",fontSize:10},axisLabel:{formatter:function(a){var b=o.yAxisFormat;return i(a,b).toString().replace(/%|万元|百万|元/g,"")}}},{name:"收益率（%）",textStyle:{color:"#666b76",fontSize:10},axisLabel:{formatter:function(a){var b=o.yAxisFormat2;return i(a,b).toString().replace(/%|万元|百万|元/g,"")}},interval:1,max:g.getAxisMax(b.data),min:0}],xAxis:{type:"category",boundaryGap:!0,axisLabel:{formatter:function(a){var b=o.xAxisFormat;return i(a,b)}},nameLocation:"end",nameGap:10,data:g.chartAxisFormat(a.xAxis,"MY")},series:_.concat(_.map(a.data,function(a){return{name:a.name,type:"bar",itemStyle:{normal:{opacity:.8}},barMaxWidth:40,data:a.data}}),_.map(b.data,function(a){return{name:a.name,type:"line",yAxisIndex:1,markLine:{data:g.getMarkLineCoords(a.data)},smooth:!1,data:a.data}}))})}var c=this,d=h.get({content:"overview",chart:"circulation"}).$promise,e=h.get({content:"overview",chart:"rate"}).$promise;b.all([d,e]).then(function(b){c.data1=g.chartDataPrune(b[0].stat),c.data2=g.chartDataPrune(b[1].stat),_.each(c.data1.data,function(a){var b=a.name.match(/上周期（(.*)）/),d=a.name.match(/本周期（(.*)）/);c.lastPeriod=b?"上周期："+b[1]:c.lastPeriod,c.thisPeriod=d?"本周期："+d[1]:c.thisPeriod}),c.data1.data=_.map(c.data1.data,function(a){return{name:a.name.replace(/周期（.+）/g,"周期发行量"),data:a.data}}),c.data2.data=_.map(c.data2.data,function(a){return{name:a.name.replace(/周期（.+）/g,"周期收益率"),data:a.data}}),a()})};var p=a.platformAssetTypeChart={chartOptions:{},yAxis:"amount",updateDate:"获取中...",yAxisFormat:"percent2",xAxis:"_id",color:g.getDimentionSpecialColor("asset_type"),xAxisFormat:null,list:[]};p.updateDataView=function(){function a(){var a=b.data,c=_.map(a.data,"name"),e=g.chartOptions("#platformAssetTypeChart",c),f=b.color||k.slice(0,c.length);b.updateDate=_.first(a.xAxis)+" ~ "+moment(_.last(a.xAxis)).weekday(6).format("YYYY-MM-DD");var h;d("views/tooltips/echart_table_tooltip.html").then(function(a){h=_.template(a,{imports:{ktValueFactory:i}})}),b.chartOptions=$.extend(!0,{},m,e,{color:_.reverse(f.slice(0)),legend:{data:c},tooltip:{reverse:!0,xAxisFormat:b.xAxisFormat,yAxisFormat:b.yAxisFormat,formatter:function(b){if(!h)return"";var c=_.reverse(b),d=c[0].name;c.length;d+=" ~ "+moment(d).weekday(6).format("YYYY-MM-DD"),_.each(c,function(b,c){b.amount=a.data[b.seriesIndex].amount[b.dataIndex],b.rate=a.data[b.seriesIndex].rate[b.dataIndex]});var e=h({title:d,params:c,color:_.reverse(f.slice(0))});return e}},yAxis:{name:"类型占比（%）",max:100,min:0},xAxis:{type:"category",name:"周",nameLocation:"end",nameGap:10,axisLabel:{interval:"auto"},boundaryGap:!0,data:a.xAxis},series:_.map(_.reverse(a.data),function(a){return{name:a.name,type:"bar",itemStyle:{normal:{opacity:.8}},stack:"类型占比",barMaxWidth:40,data:a.amount_percent}})})}var b=this;h.get({content:"overview",chart:"circulation_ratio"},function(c){b.data=g.chartDataToPercent(c.stat,"amount"),a()})},n.updateDataView(),o.updateDataView(),p.updateDataView(),h.get({content:"hodgepodge"},function(b){a.notices=b.notices,a.from_amounts=_.map(b.froms,function(a){return{name:a[0],amount:a[1]}}),a.exchange_amounts=_.map(b.exchanges,function(a){return{name:a[0],amount:a[1]}}),a.reports=b.reports,a.compass_assets_am=b.compass_ams,a.compass_assets_bond=b.compass_bonds,a.fame_assets_am=b.fame_ams,a.fame_assets_bond=b.fame_bonds})}])}();