!function(){"use strict";angular.module("kt.pano").controller("ktSettingsCtrl",["$rootScope","$timeout","$sce","$scope","$state","$location","$uibModal","$window","ktSweetAlert","ktAccountService","ktCardsService","ktUserInfoService","ktEnv","ktUpgradeMember",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n){"normal"===a.user.group&&(a.user.card_url=null),d.alertVisible=!0,d.memberGradeTip=c.trustAsHtml("非认证：注册成功但未进行名片认证，只可访问总览页。<br>已认证：注册成功且已完成名片认证，可访问市场数据和部分产品信息，不可进行检索等高级操作。<br>高级用户：可享受PANO的最高级权限，使用网站的全部功能以及全域的数据检索等。"),d.upgrade=function(){n()},d.visibleJudgement=function(b,c){var d=_.includes(b||[],a.user?a.user.status:"");return c?_.includes(c,a.user?a.user.group:"")&&d:d},d.updateProfile=function(){var b=g.open({size:"md",templateUrl:"views/modals/update_profile.html",controller:"ktUpdateProfileCtrl"});b.result.then(function(b){i.success("信息修改成功"),$.extend(a.user,b)})},d.updateBusinessCard=function(){function b(){k.delete(function(){var b=g.open({size:"md",templateUrl:"views/modals/update_business_card.html",controller:"ktUpdateBusinessCardCtrl"});b.result.then(function(b){$.extend(a.user,b)})})}"passed"===a.user.status?i.swal({title:"",text:"上传名片后需重新审核，审核通过后才有权查看所有页面，确定上传？",type:"warning",showCancelButton:!0},function(a){a&&b()}):"rejected"===a.user.status&&b()},d.updateUserStatus=function(){i.swal({title:"您确定重新提交审核吗？",text:"提交审核后，审核结果会在1个工作日内以邮件或短信的形式通知您。",showCancelButton:!0,showLoaderOnConfirm:!0},function(b){b&&k.update({content:"confirm"},function(){d.pendingRequests=!1,a.user.status="pended"},function(a){d.pendingRequests=!1,i.swal({title:"提交失败",text:$.isArray(a.error)?a.error.join("<br/>"):a.error||"抱歉，您的信息没有提交成功，请再次尝试！",type:"error"})})})},d.updatePassword=function(){var a=g.open({size:"md",templateUrl:"views/modals/update_password.html",controller:"ktUpdatePasswordCtrl"});a.result.then(function(){i.success("新密码修改成功！")})},d.updateMobile=function(){var b=g.open({size:"md",templateUrl:"views/modals/input_phone_captcha.html",controller:"ktPreUpdateMobileCtrl"});b.result.then(function(){var b=g.open({size:"md",templateUrl:"views/modals/input_phone_captcha.html",controller:"ktUpdateMobileCtrl"});b.result.then(function(b){i.success("手机修改成功！"),a.user.mobile=b.mobile})})};var o;l.get(function(b){o=b,a.user.asset_types=_.map(b.asset_types.selected,"name").join("，"),a.user.business_types=_.map(b.business_types.selected,"name").join("，")}),d.inviteUrl=m().host+"/account/register?_u="+a.user.id,d.autoCopyDisabled=h.isSafari()||h.isSogou(),d.copyTooltip="按"+(h.isWindows()?"Ctrl":"⌘")+"-C复制!",d.tooltipIsOpen=!1,d.copySuccess=function(){d.tooltipIsOpen=!0,b(function(){d.tooltipIsOpen=!1},1e3)},d.sendInviteCode=function(){j.get({content:"inviter_code"},function(){i.success("发送成功，请注意查看您的手机。")},function(a){i.error(a.error||"抱歉，系统繁忙。")})},d.updateAssetTypes=function(){var b=g.open({size:"md",templateUrl:"views/modals/prefer.html",controller:["$scope","$uibModalInstance",function(b,c){b.userInfo=o,b.submitForm=function(d){a.user.asset_types=_.chain(b.userInfo.asset_types.all).filter(function(a){return _.includes(d.asset_types,a.id)}).map("name").join("，").value(),a.user.business_types=_.chain(b.userInfo.business_types.all).filter(function(a){return _.includes(d.business_types,a.id)}).map("name").join("，").value(),c.close()},b.close=function(a){a.preventDefault(),c.dismiss("cancel")}}]});b.result.then(function(){i.success("业务偏好修改成功！")})}}]).controller("ktUpdateProfileCtrl",["$rootScope","$scope","$uibModalInstance","ktAccountService",function(a,b,c,d){b.title="修改用户信息",b.user=$.extend(!0,{},a.user),b.user.content="update",b.submitForm=function(){d.update(b.user,function(){c.close(b.user)},function(a){b.error=a.error||"更新出错！"})},b.cancel=function(a){a.preventDefault(),c.dismiss("cancel")}}]).controller("ktUpdateBusinessCardCtrl",["$rootScope","$scope","$uibModalInstance","ktSweetAlert",function(a,b,c,d){b.title="上传名片",b.user=$.extend(!0,{},a.user),b.user.card_url=null,b.user.content="update_business_card",b.submitForm=function(){d.success("信息修改成功"),c.close(b.user)},b.close=function(e,f){e.preventDefault(),f&&(d.success("信息修改成功"),a.user.card_url=b.user.card_url,a.user.status=b.user.status),c.dismiss("cancel")}}]).controller("ktPreUpdateMobileCtrl",["$rootScope","$scope","$uibModalInstance","ktAccountService","ktGetCaptcha","ktCaptchaService","ktSweetAlert",function(a,b,c,d,e,f,g){b.title="原手机号验证",b.user=$.extend(!0,{},a.user),b.user.content="validate_prev_captcha",b.user.captcha="",b.hideMobileInput=!0,b.notLastStep=!0,b.imgCaptcha={},b.refreshImgCaptcha=function(){f.get(function(a){b.imgCaptcha.url=a.url,b.imgCaptcha.img_captcha_key=a.key})},b.refreshImgCaptcha();var h=e.initCaptcha(b,d,{content:"prev_captcha"},b.user);b.getCaptcha=function(a,c){if(a.preventDefault(),a.stopPropagation(),!("sms"===c&&b.waitCaptchaMessage||"tel"===c&&b.waitCaptchaTel))return b.popForm.mobile.$invalid?(g.error("手机号号码不正确！"),void b.popForm.mobile.$setDirty()):b.popForm.img_captcha.$invalid?(g.error("请正确填写图形验证码！"),void b.popForm.img_captcha.$setDirty()):void h({mobile:b.user.mobile,img_captcha:b.user.img_captcha,img_captcha_key:b.imgCaptcha.img_captcha_key,channel:c})},b.submitForm=function(){d.update(b.user,function(){c.close(b.user)},function(a){b.error=a.error||"更新出错！"})},b.cancel=function(a){a.preventDefault(),c.dismiss("cancel")}}]).controller("ktUpdateMobileCtrl",["$rootScope","$scope","$uibModalInstance","ktAccountService","ktGetCaptcha","ktCaptchaService","ktSweetAlert",function(a,b,c,d,e,f,g){b.title="新手机号绑定",b.user=$.extend(!0,{},a.user),b.user={content:"mobile"},b.imgCaptcha={},b.refreshImgCaptcha=function(){f.get(function(a){b.imgCaptcha.url=a.url,b.imgCaptcha.img_captcha_key=a.key})},b.refreshImgCaptcha();var h=e.initCaptcha(b,d,{content:"captcha"},b.user);b.getCaptcha=function(a,c){if(a.preventDefault(),a.stopPropagation(),!("sms"===c&&b.waitCaptchaMessage||"tel"===c&&b.waitCaptchaTel))return b.popForm.mobile.$invalid?(g.error("手机号号码不正确！"),void b.popForm.mobile.$setDirty()):b.popForm.img_captcha.$invalid?(g.error("请正确填写图形验证码！"),void b.popForm.img_captcha.$setDirty()):void h({mobile:b.user.mobile,img_captcha:b.user.img_captcha,img_captcha_key:b.imgCaptcha.img_captcha_key,channel:c})},b.submitForm=function(){d.update(b.user,function(){c.close(b.user),a.user.mobile=b.user.mobile},function(a){b.error=a.error||"更新出错！"})},b.cancel=function(a){a.preventDefault(),c.dismiss("cancel")}}]).controller("ktUpdatePasswordCtrl",["$rootScope","$scope","$uibModalInstance","ktAccountService",function(a,b,c,d){b.title="修改密码",b.user=$.extend(!0,{},a.user),b.user.content="password",b.submitForm=function(){d.update(b.user,function(){c.close(b.user)},function(a){b.error=a.error||"更新出错！"})},b.cancel=function(a){a.preventDefault(),c.dismiss("cancel")}}])}();