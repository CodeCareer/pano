!function(){"use strict";angular.module("kt.pano").controller("ktMarketCtrl",["$scope","$q","$state","$timeout","$location","ktDataHelper","ktMarketAnalyticsService","ktRateTrendService","ktEchartTheme1",function(a,b,c,d,e,f,g,h,i){function j(a){var b=a.xAxis.length,c=b>2?100-100/(b-1)*3/2:25,d=b>2?100-100/(b-1)/2:75;return 5>d-c&&(c=d-5),{start:c,end:d}}function k(){var a=moment(n.start_at),b=moment(n.end_at),c=b.weeks()-a.weeks()>0;return{start_at:c?moment(n.end_at).weekday(0).subtract(1,"w").format("YYYY-MM-DD"):moment(n.start_at).weekday(0).format("YYYY-MM-DD"),end_at:c?moment(n.end_at).weekday(6).subtract(1,"w").format("YYYY-MM-DD"):moment(n.end_at).weekday(6).format("YYYY-MM-DD")}}function l(b,c){var e;return $.extend(!0,{},{show:!0,attr:{group:"group1"},styles:{position:"absolute",left:u-1,right:t-1,bottom:w,top:v},onZoom:function(c){if("manual"!==c.triggerType){var f=b.getOption().xAxis[1],g=f.data.length,h=f.data[(g-1)*c.start.toFixed(2)/100|0],i=moment(f.data[(g-1)*c.end.toFixed(2)/100|0]).day(0).add(1,"w").format("YYYY-MM-DD");d.cancel(e),e=d(function(){a.durationAmountChart.updateDataView({start_at:h,end_at:i},!0),a.durationRateChart.updateDataView({start_at:h,end_at:i},!0)},500)}}},c||{})}var m=a.shared,n=m.params;$.extend(n,e.search()),a.updateDate=moment().subtract(1,"d").format("YYYY-MM-DD"),f.filterUpdate(m.filters,m.params);var o=i.color,p="all"===n[n.dimension]||!n[n.dimension],q=function(){var a=n.dimension;return"asset_type"===a?7:"from"===a?12:6}(),r={},s=function(a){_.isEmpty(r)&&_.each(a,function(a,b){r[a]=q>b})},t=40,u=65,v=50,w=p?140:80,x={text:"努力加载中...",color:"#3d4351",textColor:"#3d4351"},y={tooltip:{valueType:"rmb"},toolbox:{show:!1},legend:{left:p?u-25:"center",right:t/2,textStyle:{fontSize:12,color:"#626472"}},yAxis:{nameGap:20,splitLine:{show:!0,lineStyle:{color:["#f3f3f3"],width:1,type:"solid"}}},grid:{show:!0,top:v,left:u,right:t,bottom:w}},z=a.weekAmountChart={chartOptions:{},_params:{},xAxis:n.dimension,yAxisFormat:"rmb",yAxis:"amount",xAxisFormat:null,list:[]},A=a.durationAmountChart={chartOptions:{},_params:k(),xAxis:n.dimension,yAxisFormat:"rmb",yAxis:"amount",xAxisFormat:null,list:[]},B=a.weekRateChart={chartOptions:{},xAxis:n.dimension,yAxisFormat:"percent2",yAxis:"rate",_filters:[{name:"期限：",options:[{name:"1M",value:1},{name:"3M",value:3},{name:"6M",value:6},{name:"1Y",value:12},{name:"2Y",value:24}]}],_getParamName:function(a){return _.find(this._filters[a].options,{value:this._params.life}).name},_params:{life:6},xAxisFormat:null,list:[]},C=a.durationRateChart={_params:k(),chartOptions:{},xAxis:n.dimension,yAxisFormat:"percent2",yAxis:"rate",xAxisFormat:null,list:[]};z.updateDataView=function(a){function b(){var a=echarts.getInstanceByDom($("#weekAmountChart")[0]),b=c.data,d=_.map(b.data,"name");s(d);var e=f.chartOptions("#weekAmountChart",d);c.chartOptions=$.extend(!0,{},y,e,{color:_.reverse(o.slice(0,d.length)),legend:{data:d,selected:r},customDataZoom:l(a,$.extend(j(b),{styles:{bottom:e.grid.bottom}})),tooltip:{axisPointer:{axis:"auto",type:"line"},reverse:!0,titleFormat:"@ToWeekEnd",titleSuffix:"发行量",xAxisFormat:c.xAxisFormat,yAxisFormat:c.yAxisFormat},yAxis:{name:"发行量（单位：万元）"},xAxis:[{type:"category",name:"周",nameLocation:"end",nameGap:10,boundaryGap:!1,data:b.xAxis},{type:"category",axisLabel:{show:!1},axisTick:{show:!1},boundaryGap:!1,data:b.xAxis}],series:_.map(_.reverse(b.data),function(a){return{name:a.name,xAxisIndex:0,stack:"总量",itemStyle:{emphasis:{shadowColor:"rgba(0,0,0,.5)"}},areaStyle:{normal:{}},type:"line",smooth:!1,data:a.data}})}),a&&a.hideLoading()}var c=this;$.extend(c._params,a||{}),g.get(f.cutDirtyParams($.extend(!0,{},n,{chart:"circulation_group_by_week_and_from"},c._params)),function(a){c.data=f.chartDataPrune(a.stat),b()})},A.updateDataView=function(a,b){function c(){var a=h.data,b=f.chartOptions("#durationAmountChart",_.map(a.data,"name"));return $.extend(!0,{},y,b,{tooltip:{xAxisFormat:h.xAxisFormat,yAxisFormat:h.yAxisFormat,reverse:!0},yAxis:{name:"发行量（单位：万元）"},xAxis:{type:"category",name:"期限",nameLocation:"end",nameGap:10,boundaryGap:!0,data:f.chartAxisFormat(a.xAxis,"MY")}})}function d(){var a=c(),b=h.data,d=_.map(b.data,"name");s(d),h.chartOptions=$.extend(!0,{},a,{color:_.reverse(o.slice(0,d.length)),legend:{data:d,selected:r},series:_.map(_.reverse(b.data),function(a){return{name:a.name,itemStyle:{emphasis:{barBorderWidth:1,barBorderColor:"rgba(0,0,0,.5)"}},stack:"总量",type:"bar",barWidth:30,data:a.data}})}),e&&e.hideLoading()}var e,h=this;$.extend(h._params,a||{}),b&&(e=echarts.getInstanceByDom($("#durationAmountChart")[0]),e&&(e.hideLoading(),e.showLoading(x))),g.get(f.cutDirtyParams($.extend(!0,{},n,{chart:"circulation_group_by_life_days_and_from"},h._params)),function(a){h.data=f.chartDataPrune(a.stat),d()})},B.updateDataView=function(a,b){function c(){var a=e.data,b=_.map(a.data,"name");s(b);var c=f.chartOptions("#weekRateChart",b);e.chartOptions=$.extend(!0,{},y,c,{legend:{data:b,selected:r},customDataZoom:l(echarts.getInstanceByDom($("#weekRateChart")[0]),$.extend(j(a),{styles:{bottom:c.grid.bottom}})),tooltip:{axisPointer:{axis:"auto",type:"line"},titleFormat:"@ToWeekEnd",titleSuffix:"收益率",xAxisFormat:e.xAxisFormat,yAxisFormat:e.yAxisFormat},yAxis:{name:"收益率（单位：%）",interval:1,max:f.getAxisMax(a.data),min:0},xAxis:[{type:"category",name:"周",nameLocation:"end",nameGap:10,boundaryGap:!1,data:a.xAxis},{type:"category",axisLabel:{show:!1},axisTick:{show:!1},boundaryGap:!1,data:a.xAxis}],series:_.map(a.data,function(a){return{name:a.name,type:"line",xAxisIndex:0,markLine:{data:f.getMarkLineCoords(a.data)},smooth:!1,data:a.data}})}),d&&d.hideLoading()}var d,e=this;$.extend(e._params,a||{}),b&&(d=echarts.getInstanceByDom($("#weekRateChart")[0]),d&&(d.hideLoading(),d.showLoading(x))),g.get(f.cutDirtyParams($.extend(!0,{},n,{chart:"rate_group_by_week_and_from"},e._params)),function(a){e.data=f.chartDataPrune(a.stat),c()})},C.updateDataView=function(a,b){function c(){var a=h.data,b=f.chartOptions("#durationRateChart",_.map(a.data,"name"));return $.extend(!0,{},y,b,{tooltip:{axisPointer:{axis:"auto",type:"line"},xAxisFormat:h.xAxisFormat,yAxisFormat:h.yAxisFormat},yAxis:{name:"收益率（单位：%）"},xAxis:{type:"category",name:"期限",nameLocation:"end",nameGap:10,boundaryGap:!1,data:f.chartAxisFormat(a.xAxis,"MY")}})}function d(){var a=h.data,b=c(),d=_.map(a.data,"name");s(d),h.chartOptions=$.extend(!0,{},b,{legend:{data:_.map(a.data,"name"),selected:r},yAxis:{interval:1,max:f.getAxisMax(a.data),min:0},series:_.map(a.data,function(a){return{name:a.name,type:"line",markLine:{data:f.getMarkLineCoords(a.data)},smooth:!1,data:a.data}})}),e&&e.hideLoading()}var e,h=this;$.extend(h._params,a||{}),b&&(e=echarts.getInstanceByDom($("#durationRateChart")[0]),e&&(e.hideLoading(),e.showLoading(x))),g.get(f.cutDirtyParams($.extend(!0,{},n,{chart:"rate_group_by_life_days_and_from"},h._params)),function(a){h.data=f.chartDataPrune(a.stat),d()})},z.updateDataView(),A.updateDataView(),B.updateDataView(),C.updateDataView(),a.assetManger={},h.get(function(b){a.assetManger=b.stat})}])}();