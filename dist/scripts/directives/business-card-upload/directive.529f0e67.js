!function(){"use strict";angular.module("kt.pano").directive("ktBusinessCard",["$rootScope","$timeout","$state","ktBusinessCardUpload","ktBusinessCardBackUpload","ktCardsService","ktBackCardsService","ktSweetAlert",function(a,b,c,d,e,f,g,h){return{restrict:"AE",scope:{ktSubmit:"&",close:"&dialogClose",uploadType:"@",user:"=ktUser",findData:"="},templateUrl:"scripts/directives/business-card-upload/template.html",link:function(i){function j(){n=b(function(){f.get(function(a){if(a.user&&a.user.card_url){var b=new Image;b.onload=function(){i.user.card_url=a.user.card_url,b=null},b.src=a.user.card_url}if(a.user&&a.user.card_back_url){var c=new Image;c.onload=function(){i.user.card_back_url=a.user.card_back_url,c=null},c.src=a.user.card_back_url}o||j()})},3500)}var k="account.perfect"===c.name?"上传名片页":"个人设置页",l=i.ktSubmit,m=i.close;i.upload=function(b){b&&b.length&&(i.pendingUpload=!0,a.bdTrack([k,"正面","上传名片"]),d({file:b[0],token:i.user.id}).then(function(a){i.pendingUpload=!1,i.user.card_url=a.data.user.card_url,i.user.status="pended","normal"===i.user.group&&(i.user.group="certified"),i.user.pended_at=new Date},function(a){h.swal({title:"失败",text:a.error||"抱歉，服务器繁忙！",type:"error"}),i.pendingUpload=!1}))},i.uploadBack=function(b){b&&b.length&&(i.pendingUploadBack=!0,a.bdTrack([k,"背面","上传名片"]),e({file:b[0],token:i.user.id}).then(function(a){i.pendingUploadBack=!1,i.user.card_back_url=a.data.user.card_back_url,i.user.status="pended","normal"===i.user.group&&(i.user.group="certified"),i.user.pended_at=new Date},function(a){h.swal({title:"失败",text:a.error||"抱歉，服务器繁忙！",type:"error"}),i.pendingUploadBack=!1}))},i.deleteCardUrl=function(b){b.stopPropagation(),f.delete(function(){i.user.card_url=null,i.cardUrlUploadShow=!1,i.user.status="rejected",i.user.reason="未上传名片正面信息",i.user.solution="请在下方上传名片信息",a.bdTrack([k,"正面","重新上传"])},function(){h.swal({title:"",text:"名片删除失败！"})})},i.deleteCardBackUrl=function(b){b.stopPropagation(),g.delete(function(){i.user.card_back_url=null,i.cardBackUrlUploadShow=!1,i.user.status="pended",i.user.pended_at=new Date,a.bdTrack([k,"背面","重新上传"])},function(){h.swal({title:"",text:"名片删除失败！"})})};var n,o=!1;j(),a.$on("$stateChangeSuccess",function(){b.cancel(n),o=!0}),i.qrcode={},i.qrcode.settings={text:location.origin+"/views/h5/ubc.html?r="+Math.random().toString(16).slice(2,8)+"&t="+i.user.id,width:340,height:340,colorDark:"#000000",colorLight:"#ffffff",correctLevel:QRCode.CorrectLevel.H},i.qrcodeBack={},i.qrcodeBack.settings={text:location.origin+"/views/h5/ubc.html?s=1&r="+Math.random().toString(16).slice(2,8)+"&t="+i.user.id,width:340,height:340,colorDark:"#000000",colorLight:"#ffffff",correctLevel:QRCode.CorrectLevel.H},i.submitForm=function(){return o=!0,b.cancel(n),l(),!1},i.closeDialog=function(a){b.cancel(n),o=!0,m(a)}}}}])}();