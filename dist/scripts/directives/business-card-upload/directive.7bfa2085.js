!function(){"use strict";angular.module("kt.pano").directive("ktBusinessCard",["$rootScope","$timeout","ktBusinessCardUpload","ktCardsService","ktSweetAlert",function(a,b,c,d,e){return{restrict:"AE",scope:{ktSubmit:"&",close:"&dialogClose",uploadType:"@",user:"=ktUser"},templateUrl:"scripts/directives/business-card-upload/template.html",link:function(f){function g(){j=b(function(){d.get(function(a){if(a.user&&a.user.card_url){var b=new Image;b.onload=function(){f.user.card_url=a.user.card_url,b=null},b.src=a.user.card_url}k||g()})},3500)}var h=f.ktSubmit,i=f.close;f.upload=function(a){a&&a.length&&(f.pendingUpload=!0,c({file:a[0],token:f.user.id}).then(function(a){f.pendingUpload=!1,f.user.card_url=a.data.user.card_url},function(a){e.swal({title:"失败",text:a.error||"抱歉，服务器繁忙！",type:"error"}),f.pendingUpload=!1}))},f.deleteCardUrl=function(a){a.stopPropagation(),f.user.card_url=null,d.delete()};var j,k=!1;g(),a.$on("$stateChangeSuccess",function(){b.cancel(j),k=!0}),f.qrcode={},f.qrcode.settings={text:location.origin+"/views/h5/ubc.html?r="+Math.random().toString(16).slice(2,8)+"&t="+f.user.id,width:340,height:340,colorDark:"#000000",colorLight:"#ffffff",correctLevel:QRCode.CorrectLevel.H},f.submitForm=function(){return f.pendingRequests=!0,d.update({content:"confirm"},function(a){f.pendingRequests=!1,k=!0,b.cancel(j),$.extend(f.user,a.account),h()},function(a){f.pendingRequests=!1,e.swal({title:"提交失败",text:$.isArray(a.error)?a.error.join("<br/>"):a.error||"抱歉，您的信息没有提交成功，请再次尝试！",type:"error"})}),!1},f.closeDialog=function(a){b.cancel(j),k=!0,i(a)}}}}])}();