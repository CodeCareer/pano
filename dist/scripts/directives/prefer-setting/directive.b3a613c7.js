!function(){"use strict";angular.module("kt.pano").directive("ktPreferSetting",["$uibModal","$q","ktUserInfoService","ktAssetTypeService","ktBusinessTypeService","ktSweetAlert",function(a,b,c,d,e,f){return{restrict:"E",replace:!0,scope:{ktSubmit:"&",close:"&dialogClose",uploadType:"@",userInfo:"=?ktUserInfo"},templateUrl:"scripts/directives/prefer-setting/template.html",link:function(g){function h(a){g.user.asset_types=_.map(a.asset_types.selected,"id"),g.user.business_types=_.map(a.business_types.selected,"id"),g.$watch("user.asset_types.length",function(){g.hasAssetType=g.user.asset_types.length?g.user.asset_types:"",g.preferForm.assetType.$setDirty(),g.preferForm.assetType.$validate()}),g.$watch("user.business_types.length",function(){g.hasBusinessType=g.user.business_types.length?g.user.business_types:"",g.preferForm.businessType.$setDirty(),g.preferForm.businessType.$validate()})}var i=g.ktSubmit,j=g.close;g.user={},g.hasAssetType="",g.hasBusinessType="",g.userInfo?h(g.userInfo):(g.userInfo={},c.get(function(a){$.extend(g.userInfo,a),h(a)})),g.assetTypesHasCustomTag=function(){return g.userInfo&&g.userInfo.asset_types&&_.some(g.userInfo.asset_types.all,{customized:!0})},g.customAssetType=function(){var b=a.open({size:"md",backdrop:"static",templateUrl:"scripts/directives/prefer-setting/add-tag-modal.html",controller:["$scope","$uibModalInstance","ktAssetTypeService",function(a,b,c){a.tag={name:""},a.title="自定义标签",a.submitForm=function(){a.pendingRequests=!0,c.save(a.tag,function(c){b.close(c),a.pendingRequests=!1},function(b){a.error=b.error||"保存失败！",a.pendingRequests=!1})},a.cancel=function(a){a.preventDefault(),b.dismiss("cancel")}}]});b.result.then(function(a){var b=a.asset_type;b.customized=!0,g.userInfo.asset_types.all.push(b)})},g.deleteCustomAssetType=function(a,b){a.stopPropagation(),d["delete"]({id:b},function(){_.remove(g.userInfo.asset_types.all,function(a){return a.id===b}),_.remove(g.user.asset_types,function(a){return a===b})},function(a){f.error(a.error||"删除失败!")})},g.businessTypesHasCustomTag=function(){return g.userInfo&&g.userInfo.business_types&&_.some(g.userInfo.business_types.all,{customized:!0})},g.customBusinessType=function(){var b=a.open({size:"md",backdrop:"static",templateUrl:"scripts/directives/prefer-setting/add-tag-modal.html",controller:["$scope","$uibModalInstance","ktBusinessTypeService",function(a,b,c){a.tag={name:""},a.title="自定义标签",a.submitForm=function(){a.pendingRequests=!0,c.save(a.tag,function(c){b.close(c),a.pendingRequests=!1},function(b){a.error=b.error||"保存失败！",a.pendingRequests=!1})},a.cancel=function(a){a.preventDefault(),b.dismiss("cancel")}}]});b.result.then(function(a){var b=a.business_type;b.customized=!0,g.userInfo.business_types.all.push(b)})},g.deleteCustomBusinessType=function(a,b){a.stopPropagation(),e["delete"]({id:b},function(){_.remove(g.userInfo.business_types.all,function(a){return a.id===b}),_.remove(g.user.business_types,function(a){return a===b})},function(a){f.error(a.error||"删除失败!")})},g.submitForm=function(){g.pendingRequests=!0;var a=d.update({},{ids:g.user.asset_types}),c=e.update({},{ids:g.user.business_types});return b.all(a.$promise,c.$promise).then(function(){var a=g.user.asset_types;g.userInfo.asset_types.selected=_.filter(g.userInfo.asset_types.all,function(b){return _.includes(a,b.id)});var b=g.user.business_types;g.userInfo.business_types.selected=_.filter(g.userInfo.business_types.all,function(a){return _.includes(b,a.id)}),i&&i({data:g.user})})["catch"](function(a){f.error(a.error||"保存失败！")}),!1},g.closeDialog=function(a){j(a)}}}}]).directive("ktChecklistLength",function(){return{require:"ngModel",scope:{length:"=ktChecklistLength"},link:function(a,b,c,d){d.$validators.ktChecklistLength=function(b){return _.isArray(b)?b.length<=a.length:!0}}}})}();